<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Now Playing on Spotify</title>
  <script src="https://cdn.tailwindcss.com"></script>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"> 

  <style>body{background:#000}</style>
</head>
<body class="min-h-screen flex items-center justify-center text-white px-6">

  <div id="card" class="bg-gray-900 rounded-2xl p-8 shadow-lg text-center max-w-md w-full">
    <h1 class="text-xl font-bold mb-4"> 
      <i class="fab fa-spotify text-green-500 text-xl"></i> Now Playing on Spotify
    </h1>

    <p id="loading" class="text-gray-400">Loading your track...</p>

    <div id="player" class="hidden">
      <img id="art" class="w-64 h-64 object-cover rounded-xl mx-auto mb-4" alt="Album Art"/>
      <h2 id="track" class="text-xl font-semibold"></h2>
      <p id="artist" class="text-gray-300"></p>
      <p id="state" class="text-sm text-gray-400 mt-2"></p>

            <div class="w-full mt-4">
        <div class="flex justify-between text-sm text-gray-400 mb-1">
          <span id="currentTime">0:00</span>
          <span id="totalTime">0:00</span>
        </div>
        <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
          <div id="progressBar" class="bg-green-500 h-2 rounded-full transition-all duration-500 ease-linear" style="width: 0%"></div>
        </div>
    </div>
  </div>

  <script>
    async function getToken(code) {
      const verifier = localStorage.getItem("code_verifier");

      const body = new URLSearchParams({
        client_id: "6dcb2a5ea17f4e078bebf78254a8236d",
        grant_type: "authorization_code",
        code,
        redirect_uri: window.location.origin + "/live.html",
        code_verifier: verifier
      });

      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      return await res.json();
    }

    function formatTime(ms) {
  const minutes = Math.floor(ms / 60000);
  const seconds = Math.floor((ms % 60000) / 1000);
  return minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
}

    async function fetchNowPlaying(access_token) {
      const res = await fetch("https://api.spotify.com/v1/me/player/currently-playing", {
        headers: { Authorization: "Bearer " + access_token }
      });

      if (res.status === 204) {
        document.getElementById("loading").textContent = "Nothing is playing right now.";
        return;
      }

      const data = await res.json();

      if (data && data.item) {
        document.getElementById("loading").classList.add("hidden");
        document.getElementById("player").classList.remove("hidden");

        document.getElementById("art").src = data.item.album.images[0].url;
        document.getElementById("track").textContent = data.item.name;
        document.getElementById("artist").textContent = data.item.artists.map(a => a.name).join(", ");
        document.getElementById("state").textContent = data.is_playing ? "▶ Playing" : "⏸ Paused";

         const progress = data.progress_ms;
    const duration = data.item.duration_ms;

    document.getElementById("currentTime").textContent = formatTime(progress);
    document.getElementById("totalTime").textContent = formatTime(duration);

    const percent = (progress / duration) * 100;
    document.getElementById("progressBar").style.width = percent + "%";
      }
    }

    // Get ?code=... from URL
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (code) {
      getToken(code).then(tokens => {
        localStorage.setItem("access_token", tokens.access_token);
        fetchNowPlaying(tokens.access_token);
        setInterval(() => fetchNowPlaying(tokens.access_token), 5000);
      });
    } else {
      document.getElementById("loading").textContent = "No code found. Go back and connect Spotify.";
    }
  </script>
</body>
</html>
